# Test Nginx configuration for Hindsight base path support
# Usage:
#   1. Start API with: export HINDSIGHT_API_BASE_PATH=/hindsight && ./scripts/dev/start-api.sh
#   2. Start Control Plane with: export NEXT_PUBLIC_BASE_PATH=/hindsight && ./scripts/dev/start-control-plane.sh
#   3. Start nginx: nginx -c $(pwd)/test-nginx.conf -p $(pwd)
#   4. Access: http://localhost:8080/hindsight/docs (API) or http://localhost:8080/hindsight/ (Control Plane)

events {
    worker_connections 1024;
}

http {
    server {
        listen 8080;
        server_name localhost;

        # Hindsight API under /hindsight
        location /hindsight/api/ {
            # Strip /api from the path before forwarding
            rewrite ^/hindsight/api/(.*) /hindsight/$1 break;

            proxy_pass http://localhost:8888;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Hindsight API (default location for /hindsight/*)
        location /hindsight/ {
            # If it looks like an API path (docs, openapi, v1, health, metrics)
            # route to API server
            if ($uri ~* "^/hindsight/(docs|openapi|v1|health|metrics|mcp)") {
                proxy_pass http://localhost:8888;
                break;
            }

            # Otherwise route to Control Plane
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (for Next.js hot reload in dev)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Next.js static files
        location ~* ^/hindsight/_next/ {
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
        }
    }
}
